# Test Caddyfile for integration tests
# Providers:
#   - openai_chat: OpenAI with chat completions style (default)
#   - openai_responses: OpenAI with responses API style
#   - anthropic: Anthropic with messages style
#
# Required env vars:
#   - OPENAI_API_KEY
#   - ANTHROPIC_API_KEY

{
	debug
}

http://localhost:19111 {
	log {
		output stderr
		level DEBUG
	}

	ai_auth_env {
		name default
	}

	ai_router {
		name default
		auth default

		# OpenAI provider using Chat Completions style (default)
		provider openai_chat {
			api_base_url "https://api.openai.com/v1"
			style "openai-chat-completions"
		}

		# OpenAI provider using Responses API style
		provider openai_responses {
			api_base_url "https://api.openai.com/v1"
			style "openai-responses"
		}

		# Anthropic provider
		provider anthropic {
			api_base_url "https://api.anthropic.com/v1"
			style "anthropic-messages"
		}

		# Model to provider mappings for testing
		default_provider_for_model gpt-4o openai_chat openai_responses
		default_provider_for_model gpt-4o-mini openai_chat openai_responses
		default_provider_for_model gpt-4.1-mini openai_chat openai_responses
		default_provider_for_model claude-sonnet-4-20250514 anthropic
		default_provider_for_model claude-3-5-sonnet-20241022 anthropic
	}

	# OpenAI Chat Completions endpoint
	handle_path /v1/chat/completions* {
		route {
			header Access-Control-Allow-Origin "*"
			header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
			header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, X-CSRF-Token, *"
			@options method OPTIONS
			respond @options 204

			ai_openai_chat_completions {
				router default
			}
		}
	}

	# OpenAI Responses endpoint
	handle_path /v1/responses* {
		route {
			header Access-Control-Allow-Origin "*"
			header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
			header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, X-CSRF-Token, *"
			@options method OPTIONS
			respond @options 204

			ai_openai_responses {
				router default
			}
		}
	}

	# Anthropic Messages endpoint
	handle_path /v1/messages* {
		route {
			header Access-Control-Allow-Origin "*"
			header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
			header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, X-CSRF-Token, *"
			@options method OPTIONS
			respond @options 204

			ai_anthropic_messages {
				router default
			}
		}
	}

	# List models endpoint
	handle_path /v1/models {
		route {
			header Access-Control-Allow-Origin "*"
			header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
			header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, X-CSRF-Token, *"
			@options method OPTIONS
			respond @options 204

			ai_list_models {
				router default
			}
		}
	}

	handle_path /health {
		respond "OK"
	}

	handle_path /* {
		respond "Not Found" 404
	}
}
